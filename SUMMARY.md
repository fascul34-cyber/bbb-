# Сводка по системе прогнозирования

## Реализованные функции

### ✅ Модели прогнозирования

1. **Baseline модели** (`models/baseline.py`)
   - Среднее значение
   - Медиана
   - Последнее значение

2. **Линейная регрессия** (`models/linear_regression.py`)
   - С подбором фичей (SelectKBest)
   - С бинарными признаками

3. **ARIMA модели** (`models/arima.py`)
   - ARIMA
   - SARIMA (сезонная)
   - SARIMAX (с экзогенными переменными)

4. **Prophet** (`models/prophet.py`)
   - С учетом праздников и сезонности

### ✅ Календарные признаки

- Праздники (российские)
- Выходные дни
- Черная пятница (Ozon и Wildberries)
- Сезонность (лето, новогодний период)
- Бинарные признаки для месяцев и дней недели

### ✅ Оценка моделей

- Метрики: MAE, RMSE, MAPE, R²
- Кросс-валидация на исторических данных
- Автоматический выбор лучшей модели для каждого продукта

### ✅ Ограничения

1. **Продукты на вывод**
   - Проверка остатков на маркетплейсах и нашем складе
   - Обнуление прогноза, если остатков нет

2. **Продукты в дефектуре**
   - Проверка остатков на складах маркетплейсов
   - Обнуление прогноза, если остатков нет

3. **Округление до коробов**
   - Настраиваемые размеры коробов
   - Округление вверх до ближайшего короба

### ✅ Расчет отгрузок

- Расчет по складам маркетплейсов
- Учет коэффициента покрытия
- Распределение отгрузок между складами
- Агрегация по месяцам

### ✅ История прогнозов

- Сохранение всех прогнозов
- Сравнение моделей
- Просмотр исторических данных

## Структура проекта

```
forecasting/
├── __init__.py
├── data_loader.py          # Загрузка и обработка данных
├── calendar_features.py    # Календарные признаки
├── forecaster.py           # Главный модуль
├── model_evaluator.py      # Оценка моделей
├── shipment_calculator.py  # Расчет отгрузок
├── constraints.py          # Ограничения
├── forecast_manager.py     # Управление прогнозами
├── analyze_data.py         # Анализ данных
├── example_usage.py        # Примеры использования
├── main.py                 # CLI интерфейс
├── README.md               # Документация
└── models/
    ├── __init__.py
    ├── baseline.py
    ├── linear_regression.py
    ├── arima.py
    └── prophet.py
```

## Основные компоненты

### DataLoader
- Загрузка данных из CSV/Excel
- Обработка дат
- Унификация колонок
- Группировка по продуктам

### CalendarFeatures
- Создание календарных признаков
- Учет праздников и выходных
- Черная пятница
- Сезонность

### SalesForecaster
- Главный класс для прогнозирования
- Координация всех компонентов
- Запуск полного цикла прогнозирования

### ModelEvaluator
- Оценка качества моделей
- Кросс-валидация
- Выбор лучшей модели

### ShipmentCalculator
- Расчет отгрузок по складам
- Анализ исторических данных
- Коэффициент покрытия

### Constraints
- Применение ограничений
- Округление до коробов
- Обработка вывода и дефектуры

### ForecastManager
- Сохранение прогнозов
- Загрузка истории
- Сравнение моделей

## Использование

### Базовое использование

```python
from forecasting.forecaster import SalesForecaster

forecaster = SalesForecaster(data_path='data', forecast_months=18)
forecaster.load_data()
forecaster.prepare_models()
results = forecaster.run_full_forecast(marketplace='wb')
```

### Запуск из командной строки

```bash
python run_forecast.py
```

или

```bash
python -m forecasting.main --data-path data --marketplace both --months 18
```

## Настройки

- Коэффициент покрытия: по умолчанию 1.5
- Размер короба: по умолчанию 24 шт.
- Период прогноза: 18 месяцев
- Метрика выбора модели: MAPE

## Результаты

После выполнения создаются файлы:
- `*_forecast.csv` - прогнозы продаж
- `*_shipments.csv` - расчетные отгрузки
- `*_model_evaluation.csv` - оценка моделей
- `*_best_models.csv` - лучшие модели

Исторические прогнозы сохраняются в `forecast_history/`

## Зависимости

- pandas >= 2.0.0
- numpy >= 1.24.0
- scikit-learn >= 1.3.0
- statsmodels >= 0.14.0 (для ARIMA)
- prophet >= 1.1.0 (для Prophet)
- holidays >= 0.34
- openpyxl >= 3.1.0 (для Excel)

## Примечания

- Система использует **Унифицированный solo-code** для идентификации продуктов
- Прогноз создается на 18 месяцев вперед (rolling forecast)
- Для каждого продукта автоматически выбирается лучшая модель
- Отрицательные прогнозы автоматически обнуляются
- Отгрузки округляются до размера короба


